<%
  # Check if this book already exists in our system
  existing_audiobook = Book.find_by(open_library_work_id: result.work_id, book_type: :audiobook)
  existing_ebook = Book.find_by(open_library_work_id: result.work_id, book_type: :ebook)

  audiobook_status = if existing_audiobook&.acquired?
    :acquired
  elsif existing_audiobook&.requests&.active&.any?
    :requested
  else
    :available
  end

  ebook_status = if existing_ebook&.acquired?
    :acquired
  elsif existing_ebook&.requests&.active&.any?
    :requested
  else
    :available
  end
%>

<div class="group relative rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 hover:scale-[1.02] bg-gray-900">
  <%# Poster Image %>
  <div class="aspect-[2/3] relative">
    <% if result.cover_url %>
      <img
        src="<%= result.cover_url(size: :m) %>"
        alt="Cover of <%= result.title %>"
        class="w-full h-full object-cover"
        loading="lazy"
        onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'w-full h-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center\'><svg class=\'w-12 h-12 text-gray-500\' fill=\'none\' stroke=\'currentColor\' viewBox=\'0 0 24 24\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'1.5\' d=\'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253\' /></svg></div>';"
      >
    <% else %>
      <div class="w-full h-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center">
        <svg class="w-12 h-12 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
      </div>
    <% end %>

    <%# Status Badges (top right) %>
    <div class="absolute top-2 right-2 flex flex-col gap-1">
      <% if audiobook_status == :acquired %>
        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-500/90 text-white backdrop-blur-sm">
          <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
          Audio
        </span>
      <% elsif audiobook_status == :requested %>
        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-500/90 text-white backdrop-blur-sm">
          <svg class="w-3 h-3 mr-1 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
          </svg>
          Audio
        </span>
      <% end %>
      <% if ebook_status == :acquired %>
        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-500/90 text-white backdrop-blur-sm">
          <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
          Ebook
        </span>
      <% elsif ebook_status == :requested %>
        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-500/90 text-white backdrop-blur-sm">
          <svg class="w-3 h-3 mr-1 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
          </svg>
          Ebook
        </span>
      <% end %>
    </div>

    <%# Year Badge (top left) %>
    <% if result.first_publish_year.present? %>
      <span class="absolute top-2 left-2 px-2 py-0.5 rounded text-xs font-medium bg-black/60 text-white backdrop-blur-sm">
        <%= result.first_publish_year %>
      </span>
    <% end %>

    <%# Hover Overlay %>
    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-3">
      <%# Request Buttons %>
      <div class="flex flex-col gap-2">
        <% if audiobook_status == :available %>
          <%= link_to new_request_path(
            work_id: result.work_id,
            title: result.title,
            author: result.author,
            cover_id: result.cover_id,
            first_publish_year: result.first_publish_year,
            book_type: 'audiobook'
          ), class: "flex items-center justify-center gap-2 w-full px-3 py-2 rounded-md text-sm font-medium bg-purple-600 hover:bg-purple-500 text-white transition-colors" do %>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
            </svg>
            Audiobook
          <% end %>
        <% end %>

        <% if ebook_status == :available %>
          <%= link_to new_request_path(
            work_id: result.work_id,
            title: result.title,
            author: result.author,
            cover_id: result.cover_id,
            first_publish_year: result.first_publish_year,
            book_type: 'ebook'
          ), class: "flex items-center justify-center gap-2 w-full px-3 py-2 rounded-md text-sm font-medium bg-blue-600 hover:bg-blue-500 text-white transition-colors" do %>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            Ebook
          <% end %>
        <% end %>

        <% if audiobook_status != :available && ebook_status != :available %>
          <div class="text-center text-sm text-gray-300 py-2">
            <% if audiobook_status == :acquired || ebook_status == :acquired %>
              Already in library
            <% else %>
              Request pending
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# Title & Author (always visible) %>
  <div class="p-3 bg-white">
    <h3 class="font-semibold text-gray-900 text-sm leading-tight line-clamp-2"><%= result.title %></h3>
    <% if result.author.present? %>
      <p class="text-xs text-gray-500 mt-1 truncate"><%= result.author %></p>
    <% end %>
  </div>
</div>
