<%
  # Check if this book already exists in our system
  existing_audiobook = Book.find_by(open_library_work_id: result.work_id, book_type: :audiobook)
  existing_ebook = Book.find_by(open_library_work_id: result.work_id, book_type: :ebook)

  audiobook_status = if existing_audiobook&.acquired?
    :acquired
  elsif existing_audiobook&.requests&.active&.any?
    :requested
  else
    :available
  end

  ebook_status = if existing_ebook&.acquired?
    :acquired
  elsif existing_ebook&.requests&.active&.any?
    :requested
  else
    :available
  end
%>

<div class="bg-white rounded-lg shadow p-4 flex gap-4">
  <div class="flex-shrink-0 w-24">
    <% if result.cover_url %>
      <img
        src="<%= result.cover_url(size: :m) %>"
        alt="Cover of <%= result.title %>"
        class="w-full rounded shadow"
        loading="lazy"
        onerror="this.onerror=null; this.src='/images/no-cover.svg';"
      >
    <% else %>
      <div class="w-full aspect-[2/3] bg-gray-200 rounded shadow flex items-center justify-center">
        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
      </div>
    <% end %>
  </div>

  <div class="flex-grow">
    <h3 class="font-semibold text-lg text-gray-900"><%= result.title %></h3>
    <% if result.author.present? %>
      <p class="text-gray-600"><%= result.author %></p>
    <% end %>
    <% if result.first_publish_year.present? %>
      <p class="text-sm text-gray-500">First published <%= result.first_publish_year %></p>
    <% end %>
    <% if result.edition_count.present? && result.edition_count > 0 %>
      <p class="text-sm text-gray-400"><%= result.edition_count %> edition<%= result.edition_count == 1 ? '' : 's' %></p>
    <% end %>

    <div class="mt-3 flex flex-wrap gap-2">
      <% if audiobook_status == :acquired %>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
          Audiobook in Library
        </span>
      <% elsif audiobook_status == :requested %>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
          </svg>
          Audiobook Requested
        </span>
      <% else %>
        <%= link_to new_request_path(
          work_id: result.work_id,
          title: result.title,
          author: result.author,
          cover_id: result.cover_id,
          first_publish_year: result.first_publish_year,
          book_type: 'audiobook'
        ), class: "inline-flex items-center px-3 py-1 rounded-full text-sm bg-purple-600 hover:bg-purple-700 text-white transition" do %>
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
          </svg>
          Request Audiobook
        <% end %>
      <% end %>

      <% if ebook_status == :acquired %>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
          Ebook in Library
        </span>
      <% elsif ebook_status == :requested %>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
          </svg>
          Ebook Requested
        </span>
      <% elsif ebook_status == :available %>
        <%= link_to new_request_path(
          work_id: result.work_id,
          title: result.title,
          author: result.author,
          cover_id: result.cover_id,
          first_publish_year: result.first_publish_year,
          book_type: 'ebook'
        ), class: "inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-600 hover:bg-blue-700 text-white transition" do %>
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
          </svg>
          Request Ebook
        <% end %>
      <% end %>
    </div>
  </div>
</div>
